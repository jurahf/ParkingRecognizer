# Описание проектов

### IVilson.AI.Yolov7net 
Работа с нейросетью YOLO для поиска объектов на фото. Используем модель yolov7_post_736x1280

### ParkingPlaces
- Модель парковки, парковочных мест, расположения камер и определения какая камера какое место видит. 
- Репозитории для получения этой информации. 
- Работа с камерами - получение изображений с камер. RTSPImageMulticamProvider (провайдер изображений с камер) запускает непрерывный процесс получения изображений.
Точнее, для каждой камеры запускается свой RTSPImageProvider. Они сохраняют изображения в папки камер \CamerasWork\\{CameraName} каждые SaveIntervalSeconds.
Изображения, хранящиеся дольше storageFilesForTime удаляются.

### Recognizer
Вызывает IVilson.AI.Yolov7net с заданным изображением, отмечает на нем распознанные автомобили, формирует результат в терминах модели.

### ParkingTelegramBot
Бот телеграм. Точка входа для сервиса. Инициирует выполнение поиска мест на парковке, отправляет данные в чат.
Бот при получении команды "Найти места" запускает команду, которая вызывает ParkingRecognizer.RecognizeAll. 
Этот метод берет каждую камеру по очереди, и получает по ней изображение (оно уже лежит в папке).
Каждое изображение отправляется в yolo, по результатам заполняется, какие места свободные, какие заняты, и рисуется на изображении.
Бот отправлет текстовый ответ и прикладывает изображения с результатом пользователю.

# Для запуска
1. Добавить нужную модель YOLO в \src\Yolov7net\Assets в формате onnx. Настройка в классе YoloFactory. Сейчас используется YOLO7 с постобработкой - yolov7_post_736x1280. Поискать модели можно например тут - https://github.com/PINTO0309/PINTO_model_zoo/tree/main/307_YOLOv7
2. Создать структуру каталогов для изображений с камеры. Для каждой камеры должен быть свой каталог - \CamerasWork\\{CameraName}. В каждом каталоге должен лежать ffmpeg.exe. Скачать его можно с https://github.com/BtbN/FFmpeg-Builds/releases
3. Для работы с камерой, нужно указать ссылки на RTSP-видео. Сейчас все данные камер и парковки содержатся в parking.json. Поток с IP камеры можно проверить с помощью https://www.ispyconnect.com/docs/agent/trayapp.
4. Для распознавания нужно иметь разметку (места на парковке и координаты на изображениях с камер). Сейчас это все задается в parking.json. Позже будет создан UI для создания этого JSON в визуальном редакторе.


# Что еще сделано
1. UI для разметки парковки местами - сгенерирован UI на Blazor
2. Поддержка нескольких камер - требуется несколько ffmpeg.exe
3. Результат распознавания кешируется на 1 минуту, отдается из кеша, если есть.


# Что еще надо сделать
1. Распознавание запускать время от времени, чтобы при обработке запроса от бота всегда выдавать закешированный результат (быстрый ответ). Но возможно всегда будет создавать лишнюю нагрузку на комп.
2. Сделать как службу  ```sc create TestService binpath= C:\Path\To\myservice.exe```
3. Учет пользователей (для статистики - сохранять кто писал, а может и сколько каждый писал и когда) - можно брать из лога
4. UI для задания настроек подключения камер
5. Админский режим для бота - передавать конфигурацию камер через специальные команды, забирать логи
7. Удаление старых логов
8. Производительность - кеш, параллельный запуск распознавания


# Использованные ресурсы

https://github.com/ivilson/Yolov7net

https://github.com/nager/Nager.VideoStream

https://github.com/BtbN/FFmpeg-Builds/releases

